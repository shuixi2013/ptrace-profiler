////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifndef __STACK_CORKSCREW_H__
#define __STACK_CORKSCREW_H__

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include <json-node.h>

#include <json-populator.h>

#include <stdint.h>

#include <vector>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifdef WIN32

#define pid_t uint32_t

#endif

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

typedef uint32_t StackToken;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class StackFrame
{
public:

  StackFrame ()
    : m_level (0)
    , m_pc (0)
    , m_sp (0)
  {
    m_function [0] = '\0';
  }

  uint64_t m_level;

  uint64_t m_pc;

  uint64_t m_sp;

  char m_function [128];

};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class StackCorkscrew : public JsonPopulator
{
public:

  virtual size_t Unwind (pid_t ppid, pid_t tid, size_t ignoreDepth, size_t maxDepth) = 0;

  bool GetFrame (size_t index, StackFrame &frame) const;

  bool PushFrame (const StackFrame &frame);

  size_t GetDepth () const;

  bool PopulateJsonObject (JsonNode &node) const override;

  bool PopulateJsonArray (JsonNode &node) const override;

protected:

  friend class StackSymbolicator;

  StackCorkscrew ();

  ~StackCorkscrew ();

  StackCorkscrew (const StackCorkscrew &rhs);

  std::vector <StackFrame> m_frames;

};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class StackCorkscrewLibcppabi : public StackCorkscrew
{
public:

  size_t Unwind (pid_t ppid, pid_t tid, size_t ignoreDepth, size_t maxDepth) override;

};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class StackCorkscrewLibunwind : public StackCorkscrew
{
public:

  size_t Unwind (pid_t ppid, pid_t tid, size_t ignoreDepth, size_t maxDepth) override;

};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#endif // __STACK_CORKSCREW_H__

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
