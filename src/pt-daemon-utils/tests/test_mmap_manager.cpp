////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "mmap_manager.h"

#include <stdio.h>

#include <errno.h>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static const char *g_mapsFileTestData = "\
a111a000-a111b000 ---p 00000000 00:00 0 \n\
13201000-22c00000 ---p 00601000 00:04 159        /dev/ashmem/dalvik-main space (deleted)\n\
6f638000-70153000 rw-p 00000000 08:13 40965      /data/dalvik-cache/x86/system@framework@boot.art\n\
a111c000-a1218000 rw-p 00000000 00:00 0          [stack:2262]\n\
a2a00000-a3400000 rw-p 00000000 00:00 0          [anon:libc_malloc]\n\
a3532000-a3735000 r--p 00000000 08:13 41136      /data/dalvik-cache/x86/data@app@ApiDemos@ApiDemos.apk@classes.dex\n\
a3f9f000-a3fad000 r-xp 00000000 08:06 711        /system/lib/egl/libGLESv2_emulation.so\n\
b0202000-b023d000 r--p 00000000 08:06 613        /system/fonts/Roboto-Regular.ttf\n\
b36f7000-b3701000 r--s 004fc000 08:13 14         /data/app/ApiDemos/ApiDemos.apk\n\
b4888000-b48a8000 r--s 00000000 00:0c 8201       /dev/__properties__\n\
b7783000-b7786000 r-xp 00000000 08:06 143        /system/bin/app_process32\n\
";

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int main (int argc, char* argv [])
{
  // 
  // Validate /proc/<pid>/maps parsing logic.
  // 

  {
    const char *filename = "maps.txt";

    FILE *mapsFile = fopen (filename, "w");

    size_t dataSize = strlen (g_mapsFileTestData);

    if (fwrite (g_mapsFileTestData, 1, dataSize, mapsFile) != dataSize)
    {
      fprintf (stderr, "Failed to export test JSON buffer. %s.\n", strerror (errno));

      fflush (stderr);

      errno = 0;

      return 1;
    }

    fflush (mapsFile);

    fclose (mapsFile);

    MemoryMapManager manager;

    if (manager.ParseUnixProcessMapsFile (filename) == 0)
    {
      fprintf (stderr, "Failed to process maps file (%s).\n", filename);

      fflush (stderr);

      return 1;
    }

    std::string json;

    if (!manager.ConvertToJSON (json))
    {
      fprintf (stderr, "Failed to convert mmap manager to JSON.\n");

      fflush (stderr);

      return 1;
    }

    if (remove (filename) != 0)
    {
      fprintf (stderr, "Failed to delete test file. %s.\n", filename, strerror (errno));

      fflush (stderr);

      errno = 0;

      return 1;
    }
  }

  return 0;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////